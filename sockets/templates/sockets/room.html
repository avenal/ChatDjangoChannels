<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Chat</title>
</head>

<body>
  {% if messages %}
  {% for message in messages %}
  <p id="alert">{{message}}</p>
  {% endfor %}
  {% endif %}
  <a href="javascript:{document.getElementById('logout').submit()}" class="nav-link">
    <i class="fas fa-sign-out-alt"></i> Wyloguj
  </a>
  <form action="{% url 'logout' %}" method="POST" id="logout">
    {% csrf_token %}
    <input type="hidden">
  </form>
  <textarea id="chat-log" cols="100" rows="20"></textarea><br />
  <input id="chat-message-input" type="text" size="100" /><br />
  <input id="chat-message-submit" type="button" value="WyÅ›lij" />
  {{ room_name|json_script:"room-name" }}
  <script>
    const roomName = JSON.parse(
      document.getElementById("room-name").textContent
    );
    const chatSocket = new WebSocket(
      "ws://" + window.location.host + "/ws/chat/" + roomName + "/"
    );
    chatSocket.onopen = e => {};
    chatSocket.onmessage = function (e) {
      data = JSON.parse(e.data);
      document.getElementById('chat-log').value += data.user + ": " + data.message + '\n';
    };
    chatSocket.onclose = function (e) {
      console.error("Chat socket closed unexpectedly");
    };
    document.querySelector("#chat-message-input").focus();
    document.querySelector("#chat-message-input").onkeyup = function (e) {
      if (e.keyCode === 13) {
        document.querySelector("#chat-message-submit").click();
      }
    };
    document.querySelector("#chat-message-submit").onclick = function (e) {
      const messageInputDom = document.querySelector("#chat-message-input");
      const message = messageInputDom.value;
      chatSocket.send(
        JSON.stringify({
          message: message
        })
      );
      messageInputDom.value = "";
    };
  </script>
  <script>
    x = document.getElementById('alert');
    setTimeout(() => {
      x.remove();
    }, 3000)
  </script>
</body>
</html>